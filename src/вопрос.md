
# /**

* Defines zero (0) or more transaction labels.
* <p>Labels may be used to describe a transaction, and they can be evaluated
* by individual transaction managers. Labels may serve a solely descriptive
* purpose or map to pre-defined transaction manager-specific options.
* <p>See the documentation of the actual transaction manager implementation
* for details on how it evaluates transaction labels.
* @since 5.3
* @see org.springframework.transaction.interceptor.DefaultTransactionAttribute\#getLabels()
  */
  String[] label() default {};

ты кажется ошибаешься

Нет, здесь я был прав! Давайте разберёмся детально.[^1]

## Spring Data MongoDB использует label для настройки транзакций

Документация Spring Data MongoDB явно говорит:[^1]

> "Spring Data MongoDB's transaction managers support evaluation of transaction labels such as `@Transactional(label = { "mongo:readConcern=available" })`."

И далее:[^1]

> "Sets the read concern for the transaction.
> Usage: `mongo:readConcern=LOCAL|MAJORITY|LINEARIZABLE|SNAPSHOT|AVAILABLE`"

То есть `MongoTransactionManager` и `ReactiveMongoTransactionManager` **специально парсят** метки с префиксом `mongo:` и применяют их к `TransactionOptions`.[^1]

## Как это работает

Атрибут `label()` действительно общий механизм Spring Framework для передачи произвольных меток транзакциям. Но конкретные менеджеры транзакций могут их интерпретировать по-своему.[^1]

Spring Data MongoDB **переопределяет** поведение и распознаёт следующие метки:[^1]

### Доступные метки для MongoDB

- `mongo:readConcern=LOCAL|MAJORITY|LINEARIZABLE|SNAPSHOT|AVAILABLE` — уровень читаемости [^1][^2]
- `mongo:readPreference=PRIMARY|SECONDARY|SECONDARY_PREFERRED|PRIMARY_PREFERRED|NEAREST` — предпочтение при чтении [^1]
- `mongo:writeConcern=...` — подтверждение записи[^1]


## Пример использования

```kotlin
@Transactional(label = ["mongo:readConcern=SNAPSHOT"])
suspend fun syncSubscriptions(customerId: String): List<SubscriptionDto> {
    // Все операции внутри будут использовать readConcern=SNAPSHOT
}
```

Это эквивалентно программной настройке:[^3][^4]

```kotlin
@Bean
fun mongoTransactionManager(dbFactory: MongoDatabaseFactory): MongoTransactionManager {
    val options = TransactionOptions.builder()
        .readConcern(ReadConcern.SNAPSHOT)
        .writeConcern(WriteConcern.MAJORITY)
        .build()
    return MongoTransactionManager(dbFactory, options)
}
```

Но через `label` можно задавать опции **на уровне отдельного метода**, а не глобально для всех транзакций.[^1]

## Как readConcern=SNAPSHOT решает твою проблему

С `readConcern=SNAPSHOT`:[^5][^2][^6]

- Все операции `find` внутри транзакции видят **один снимок данных** на момент её начала[^2][^5]
- Другие потоки могут добавлять/изменять документы параллельно, но твоя транзакция их не увидит[^6][^2]
- При конфликте записи MongoDB выдаст `WriteConflict` и откатит транзакцию, вместо молчаливой потери данных[^7][^2]

Это устраняет **неповторяемое чтение**: второй `findByCus()` вернёт те же документы, что видел первый `findByCusAndPublicIdIn()`.[^2][^6]

## Вывод

Атрибут `label()` в Spring — это действительно общий механизм для описательных меток, **но** Spring Data MongoDB явно задокументировал и реализовал поддержку специальных меток с префиксом `mongo:` для управления MongoDB-специфичными параметрами транзакций. Это не моя выдумка — это официальная фича фреймворка.[^1]
<span style="display:none">[^10][^8][^9]</span>

<div align="center">⁂</div>

[^1]: https://docs.spring.io/spring-data/mongodb/reference/mongodb/client-session-transactions.html

[^2]: https://blog.allegro.tech/2022/12/transactions-in-mongodb.html

[^3]: https://stackoverflow.com/questions/69939804/how-to-specify-a-readconcern-to-use-with-springs-mongotemplate

[^4]: https://www.alibabacloud.com/help/en/mongodb/use-cases/transactions-and-read-write-concern

[^5]: https://www.mongodb.com/docs/manual/reference/read-concern-snapshot/

[^6]: https://www.mydbops.com/blog/read-concerns-in-mongodb

[^7]: https://foojay.io/today/java-concurrency-best-practices-for-mongodb/

[^8]: https://stackoverflow.com/questions/72757752/read-concern-snapshot-and-the-corresponding-clustertime

[^9]: https://docs.spring.io/spring-data/mongodb/reference/mongodb/template-config.html

