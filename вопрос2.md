<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# —Ç–æ–≥–¥–∞ —Ç—ã —Å—á–∏—Ç–∞–µ—à—å —á—Ç–æ –≤–æ—Ç –∑–¥–µ—Å—å

/**

* –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ —Å –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–æ–º
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
*
* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç ACID —Å–≤–æ–π—Å—Ç–≤–∞:
*     - –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å: –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–≤—Å–µ –∏–ª–∏ –Ω–∏—á–µ–≥–æ)
*     - –ò–∑–æ–ª—è—Ü–∏—è: snapshot isolation –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø–æ–≤—Ç–æ—Ä—è–µ–º–æ–µ —á—Ç–µ–Ω–∏–µ
*     - –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ publicId –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
*     - –î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å: commit —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
*
* @param customerId ID –∫–ª–∏–µ–Ω—Ç–∞ (cus)
* @return —Å–ø–∏—Å–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
  */
  @Transactional
  suspend fun syncSubscriptions(customerId: String): List<SubscriptionDto> {
  log.info("üîÑ [–ü–æ–¥—Ö–æ–¥ 3] –ù–∞—á–∞–ª–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞: {}", customerId)

try {
// –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
val externalResponse = externalClient.fetchSubscriptions(customerId)
val externalSubscriptions = externalResponse.subscriptions
log.info("üì• –ü–æ–ª—É—á–µ–Ω–æ {} –ø–æ–¥–ø–∏—Å–æ–∫ –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞", externalSubscriptions.size)

     // –®–∞–≥ 2: –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–ø–∏—Å–æ–∫ publicId –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫
     val externalPublicIds = externalSubscriptions.map { UUID.fromString(it.subscriptionId) }
     log.debug("üîë –ò–∑–≤–ª–µ—á–µ–Ω–æ {} publicId –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫", externalPublicIds.size)
    
     // –®–∞–≥ 3: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –í –¢–†–ê–ù–ó–ê–ö–¶–ò–ò
     // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç snapshot isolation - –≤–∏–¥–∏–º —Å–Ω–∏–º–æ–∫ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
     // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø–æ–≤—Ç–æ—Ä—è–µ–º–æ–µ —á—Ç–µ–Ω–∏–µ: –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –¥–æ–±–∞–≤–∏—Ç –ø–æ–¥–ø–∏—Å–∫—É,
     // –º—ã –µ–µ –Ω–µ —É–≤–∏–¥–∏–º –¥–æ commit –µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
     val existingSubscriptions = repository.findByCusAndPublicIdIn(customerId, externalPublicIds)
     log.info("üíæ –ù–∞–π–¥–µ–Ω–æ {} —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –≤ –ë–î (–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)", existingSubscriptions.size)
    
     // –®–∞–≥ 4: –°–æ–∑–¥–∞–µ–º Map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
     val existingMap = existingSubscriptions.associateBy { it.publicId }
     log.debug("üó∫Ô∏è –°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫: {} –∑–∞–ø–∏—Å–µ–π", existingMap.size)
    
     // –®–∞–≥ 5: –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –æ–±–Ω–æ–≤–ª—è–µ–º—ã–µ –∏ –Ω–æ–≤—ã–µ
     val toUpdate = mutableListOf<SubscriptionEntity>()
     val toCreate = mutableListOf<SubscriptionEntity>()
    
     externalSubscriptions.forEach { externalDto ->
         val publicId = UUID.fromString(externalDto.subscriptionId)
         val existing = existingMap[publicId]
    
         if (existing != null) {
             // –ü–æ–¥–ø–∏—Å–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –æ–±–Ω–æ–≤–ª—è–µ–º
             mapper.updateEntity(existing, externalDto)
             toUpdate.add(existing)
             log.debug("‚úèÔ∏è –ü–æ–¥–ø–∏—Å–∫–∞ {} –ø–æ–º–µ—á–µ–Ω–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", publicId)
         } else {
             // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
             val newEntity = mapper.toEntity(externalDto, customerId)
             toCreate.add(newEntity)
             log.debug("‚ûï –ü–æ–¥–ø–∏—Å–∫–∞ {} –ø–æ–º–µ—á–µ–Ω–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è", publicId)
         }
     }
    
     log.info("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –æ–±–Ω–æ–≤–∏—Ç—å={}, —Å–æ–∑–¥–∞—Ç—å={}", toUpdate.size, toCreate.size)
    
     // –®–∞–≥ 6: Batch —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –í –¢–†–ê–ù–ó–ê–ö–¶–ò–ò
     // –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ - –ª–∏–±–æ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ, –ª–∏–±–æ –≤—Å–µ –æ—Ç–∫–∞—Ç—è—Ç—Å—è
     // Snapshot isolation –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º—ã —Ä–∞–±–æ—Ç–∞–µ–º —Å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º —Å–Ω–∏–º–∫–æ–º –¥–∞–Ω–Ω—ã—Ö
     // –ï—Å–ª–∏ –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –¥–æ–±–∞–≤–∏–ª –ø–æ–¥–ø–∏—Å–∫—É –ø–æ—Å–ª–µ –Ω–∞—á–∞–ª–∞ –Ω–∞—à–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –º—ã –µ–µ –Ω–µ —É–≤–∏–¥–∏–º
     // –¥–æ commit –µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —á—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition
     val allToSave = toUpdate + toCreate
     if (allToSave.isNotEmpty()) {
         val saved = repository.saveAll(allToSave).toList()
         log.info("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {} –ø–æ–¥–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ saveAll –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏", saved.size)
     }
    
     // –®–∞–≥ 7: –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ (–≤—Å–µ –µ—â–µ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
     val result = repository.findByCus(customerId).toList()
     log.info("‚úÖ [–ü–æ–¥—Ö–æ–¥ 3] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í—Å–µ–≥–æ –ø–æ–¥–ø–∏—Å–æ–∫: {}", result.size)
    
     // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ DTO
     return result.map { entity ->
         SubscriptionDto(
             id = entity.id?.toHexString(),
             publicId = entity.publicId,
             cus = entity.cus,
             offerId = entity.offerId,
             status = entity.status,
             balance = entity.balance,
             createdAt = entity.createdAt,
             updatedAt = entity.updatedAt,
             vendorStatus = entity.vendorStatus,
             vendorBalance = entity.vendorBalance,
             lastSyncTime = entity.lastSyncTime,
             usageCount = entity.usageCount,
             urlLogo = entity.urlLogo,
             brand = entity.brand
         )
     }
    } catch (ex: Exception) {
// –ü—Ä–∏ –æ—à–∏–±–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–∞—Ç–∏—Ç—Å—è
log.error("‚ùå –û—à–∏–±–∫–∞ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞: {}. –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–∫–∞—á–µ–Ω—ã.", customerId, ex)
throw ex
}
}

–Ω–µ –±—É–¥–µ—Ç —ç—Ç–æ —Ä–∞–±–æ—Ç–∞—Ç—å –µ—Å–ª–∏ —è –Ω–µ –ø–æ—Å—Ç–∞–≤–ª—é —ç—Ç–æ—Ç label ?

–∫—Ä–æ–º–µ —Ç–æ–≥–æ. –≤–æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.

options: 'authMechanism=SCRAM-SHA-256\&replicaSet=enrichment-subscriptions-set\&maxPoolSize=50\&minPoolSize=5\&maxIdleTimeMS=30000\&maxLifeTimeMS=36000\&retryWrites=true\&w=majority\&readPreference=primary\&serverSelectionTimeoutMS=5000\&connectTimeoutMS=5000\&authSource=subscriptions-showcase'

–ò–∑–≤–∏–Ω—è—é—Å—å, –±—ã–ª —á–∞—Å—Ç–∏—á–Ω–æ –Ω–µ—Ç–æ—á–µ–Ω –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç–≤–µ—Ç–µ. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º –¥–µ—Ç–∞–ª—å–Ω–æ.[^1][^2][^3]

## –ë—É–¥–µ—Ç –ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ label?

**–î–∞, snapshot isolation —Ä–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è label**.[^2][^3]

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π MongoDB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

MongoDB —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ **–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** –∏–º–µ—é—Ç **snapshot isolation –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ `readConcern`. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:[^3][^2]

- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–∏–¥—è—Ç **–æ–¥–∏–Ω –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π —Å–Ω–∏–º–æ–∫ –¥–∞–Ω–Ω—ã—Ö** –Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏[^2][^3]
- –î–∞–∂–µ –µ—Å–ª–∏ –≤—ã —è–≤–Ω–æ —É–∫–∞–∂–µ—Ç–µ `readConcern: "local"`, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤—Å—ë —Ä–∞–≤–Ω–æ –±—É–¥–µ—Ç –≤–µ—Å—Ç–∏ —Å–µ–±—è –∫–∞–∫ snapshot –Ω–∞ **—É—Ä–æ–≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**[^3]

–¶–∏—Ç–∞—Ç–∞ –∏–∑ –æ–±—Å—É–∂–¥–µ–Ω–∏—è:[^2]

> "With regard to transactions (which requires the use of sessions), **the default isolation is snapshot**."

–ò –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:[^3]

> "The transaction is acting as a snapshot when I'm clearly setting readConcern to local."

### –ó–∞—á–µ–º —Ç–æ–≥–¥–∞ label?

–ê—Ç—Ä–∏–±—É—Ç `label = ["mongo:readConcern=SNAPSHOT"]` –Ω—É–∂–µ–Ω –¥–ª—è **—è–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –£–†–û–í–ù–Ø snapshot**:[^4][^5]

- `readConcern: "local"` ‚Äî snapshot –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –Ω–æ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ majority-committed[^6][^1]
- `readConcern: "snapshot"` ‚Äî snapshot **–∏–∑ majority-committed –¥–∞–Ω–Ω—ã—Ö**, –≥–∞—Ä–∞–Ω—Ç–∏—è —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–∫–∞—Ç—è—Ç—Å—è –ø—Ä–∏ failover[^5][^7]
- `readConcern: "majority"` ‚Äî —Ç–æ–∂–µ majority-committed, –Ω–æ –±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–∏ snapshot –¥–ª—è multi-shard –æ–ø–µ—Ä–∞—Ü–∏–π[^7][^8]


## –í–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

–í–∞—à–∞ —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è **–∏–¥–µ–∞–ª—å–Ω–∞** –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:[^9][^10]

```
replicaSet=enrichment-subscriptions-set  # ‚úÖ Replica set –µ—Å—Ç—å ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
retryWrites=true                        # ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry
w=majority                              # ‚úÖ Write concern majority
readPreference=primary                  # ‚úÖ –ß–∏—Ç–∞–µ–º —Å primary
```

–£ –≤–∞—Å –µ—Å—Ç—å –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ.[^10][^11][^9]

## –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –≤ –≤–∞—à–µ–º –∫–æ–¥–µ

### –ë–µ–∑ @Transactional

Race condition **–≤–æ–∑–º–æ–∂–µ–Ω**:[^12][^13]

```kotlin
// –ü–æ—Ç–æ–∫ 1: –Ω–∞—Ö–æ–¥–∏—Ç 5 –ø–æ–¥–ø–∏—Å–æ–∫
val existing = repository.findByCusAndPublicIdIn(...)

// –ü–æ—Ç–æ–∫ 2: –¥–æ–±–∞–≤–ª—è–µ—Ç 6-—É—é –ø–æ–¥–ø–∏—Å–∫—É
repository.save(newSubscription)

// –ü–æ—Ç–æ–∫ 1: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–≤–æ–∏ 5, –Ω–µ –∑–Ω–∞—è –æ 6-–æ–π
repository.saveAll(toUpdate + toCreate)

// –ü–æ—Ç–æ–∫ 1: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å 6-–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π
val result = repository.findByCus(customerId)
```

–†–µ–∑—É–ª—å—Ç–∞—Ç: **–Ω–µ–ø–æ–≤—Ç–æ—Ä—è–µ–º–æ–µ —á—Ç–µ–Ω–∏–µ** ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π `findByCus` –≤–µ—Ä–Ω—ë—Ç –±–æ–ª—å—à–µ –∑–∞–ø–∏—Å–µ–π, —á–µ–º –≤–∏–¥–µ–ª –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å.[^13][^12]

### –° @Transactional (–¥–∞–∂–µ –ë–ï–ó label)

Snapshot isolation **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç**:[^2][^3]

```kotlin
@Transactional
suspend fun syncSubscriptions(...) {
    // –ù–∞—á–∞–ª–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è —Å–Ω–∏–º–æ–∫ –¥–∞–Ω–Ω—ã—Ö
    
    val existing = repository.findByCusAndPublicIdIn(...)  // –í–∏–¥–∏—Ç —Å–Ω–∏–º–æ–∫ T0
    
    // –î—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É ‚Üí –Ω–µ –≤–∏–¥–∏–º –≤ —ç—Ç–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    
    repository.saveAll(...)  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    
    val result = repository.findByCus(customerId)  // –í–°–ï–ì–î–ê –≤–∏–¥–∏—Ç —Ç–æ—Ç –∂–µ —Å–Ω–∏–º–æ–∫ T0
    
    // Commit ‚Äî –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ
}
```

–†–µ–∑—É–ª—å—Ç–∞—Ç: **–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞** ‚Äî –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ `find` –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–∏–¥—è—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Å–Ω–∏–º–æ–∫.[^3][^2]

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –≤–∞—à–µ–≥–æ —Å–ª—É—á–∞—è

–î–ª—è –≤–∞—à–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ **–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ—Å—Ç–æ `@Transactional`** –±–µ–∑ label:[^2]

```kotlin
@Transactional
suspend fun syncSubscriptions(customerId: String): List<SubscriptionDto>
```

–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç:[^3][^2]

- **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å**: –≤—Å—ë –∏–ª–∏ –Ω–∏—á–µ–≥–æ[^11]
- **Snapshot isolation**: –≤—Å–µ `find` –≤–∏–¥—è—Ç –æ–¥–∏–Ω —Å–Ω–∏–º–æ–∫[^2][^3]
- **–ó–∞—â–∏—Ç—É –æ—Ç race condition**: –¥—Ä—É–≥–∏–µ –ø–æ—Ç–æ–∫–∏ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –≤–∞—à —Å–Ω–∏–º–æ–∫ –¥–∞–Ω–Ω—ã—Ö[^3][^2]

–£–∫–∞–∑—ã–≤–∞—Ç—å `label = ["mongo:readConcern=SNAPSHOT"]` –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:[^8][^5]

- –í—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ —Å **sharded cluster** –∏ –Ω—É–∂–Ω–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å **–º–µ–∂–¥—É —à–∞—Ä–¥–∞–º–∏**[^14][^8]
- –í–∞–º –∫—Ä–∏—Ç–∏—á–Ω–æ, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ **majority-committed** –∏ –Ω–µ –æ—Ç–∫–∞—Ç–∏–ª–∏—Å—å –ø—Ä–∏ failover[^5][^7]

–í –≤–∞—à–µ–º —Å–ª—É—á–∞–µ (replica set, single-shard –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –æ–¥–Ω–æ–º—É `customerId`) **–¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ**.[^2][^3]
<span style="display:none">[^15][^16][^17][^18][^19][^20][^21][^22][^23][^24][^25][^26][^27]</span>

<div align="center">‚ÅÇ</div>

[^1]: https://www.mongodb.com/docs/manual/reference/read-concern/

[^2]: https://stackoverflow.com/questions/60156222/changing-mongodb-isolation-level-when-mongo-sessions-involved

[^3]: https://www.mongodb.com/community/forums/t/transaction-with-read-concern-local-doesnt-behave-as-expected/212937

[^4]: https://docs.spring.io/spring-data/mongodb/reference/mongodb/client-session-transactions.html

[^5]: https://www.mongodb.com/docs/manual/reference/read-concern-snapshot/

[^6]: https://www.mongodb.com/docs/manual/reference/read-concern-local/

[^7]: https://www.mongodb.com/docs/manual/reference/read-concern-majority/

[^8]: https://www.mongodb.com/resources/products/capabilities/performance-best-practices-transactions-and-read-write-concerns

[^9]: https://www.mongodb.com/community/forums/t/why-replica-set-is-mandatory-for-transactions-in-mongodb/9533

[^10]: https://www.geeksforgeeks.org/mongodb/using-transactions-in-mongodb/

[^11]: https://www.mongodb.com/company/blog/product-release-announcements/mongodb-multi-document-acid-transactions-general-availability

[^12]: https://www.mongodb.com/docs/manual/core/read-isolation-consistency-recency/

[^13]: https://dzone.com/articles/mongodb-isolation-level-transactions

[^14]: https://www.xuchao.org/docs/mongodb/reference/read-concern-snapshot.html

[^15]: https://www.mongodb.com/docs/manual/reference/mongodb-defaults/

[^16]: https://www.mydbops.com/blog/read-concerns-in-mongodb

[^17]: https://stackoverflow.com/questions/69939804/how-to-specify-a-readconcern-to-use-with-springs-mongotemplate

[^18]: https://www.xuchao.org/docs/mongodb/reference/mongodb-defaults.html

[^19]: https://docs.mongock.io/v5/driver/mongodb-springdata/index.html

[^20]: https://dev.to/mongodb/isolation-level-for-mongodb-multi-document-transactions-3lfi

[^21]: https://www.mongodb.com/docs/manual/core/transactions/

[^22]: https://stackoverflow.com/questions/53908672/whats-the-difference-of-majority-committed-data-and-the-snapshot-of-majority

[^23]: https://www.php.net/manual/en/class.mongodb-driver-readconcern.php

[^24]: https://www.mongodb.com/community/forums/t/correctly-exploiting-causal-consistency-and-snapshot-reads/141087

[^25]: https://www.digitalocean.com/community/tutorials/how-to-use-transactions-in-mongodb

[^26]: https://stackoverflow.com/questions/63847672/mongodb-snapshot-read-concern-does-not-lock-read-documents

[^27]: https://docs.spring.io/spring-data/data-mongo/docs/current/api/org/springframework/data/mongodb/MongoTransactionOptionsResolver.html

